<!-- https://www.w3schools.com/howto/howto_js_image_comparison.asp-->
<doctype HTML>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <head>

        <link
            href="https://fonts.googleapis.com/css?family=Noto+Sans:400,400i,700,700i|Oswald:200,300,400,500,600,700&display=swap&subset=latin-ext"
            rel="stylesheet">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/site.css">
        <script src="https://code.jquery.com/jquery-3.5.0.js"
            integrity="sha256-r/AaFHrszJtwpe+tHyNi/XCfMxYpbsRg2Uqn0x3s2zc=" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

        <script src="libs/d3.v4.min.js"></script>
        <script src="libs/d3.v4.jetpack.min.js"></script>
        <script src="libs/d3-scale-chromatic.v1.min.js"></script>
        <script src="libs/topojson.v1.min.js"></script>
        <script src="libs/d3-queue.v3.min.js"></script>
        <script src="https://unpkg.com/roughjs@latest/bundled/rough.js"></script>
        <link rel="icon" href="img/favicon.ico">
        <script>

            dataLayer = [{

                "siteName": "oecd.github.io/EO-Outlook_chart_1",

                "siteEnvironment": "live",

                "pageLanguage": "en",         // or "en" or "es"

                "contentLanguage": "English",  // or "English" or "French"

                "pageTopic": "Economic Outlook",

                "pageSubTopic": "",

                "pageCountry": "",

                "pageCategory": ""

            }];

        </script>



        <!-- Google Tag Manager -->

        <script>(function (w, d, s, l, i) {
                w[l] = w[l] || []; w[l].push({
                    'gtm.start':

                        new Date().getTime(), event: 'gtm.js'
                }); var f = d.getElementsByTagName(s)[0],

                    j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =

                        'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);

            })(window, document, 'script', 'dataLayer', 'GTM-P5JSM4P');</script>

        <!--End Google Tag Manager -->
    </head>

<body>
    <h1>Coolio on the title</h1><h2>Drag the cursor to see the impact of the Covid crisis depending on the scenario</h1>
    <div id="modedemploi">
        <div id="#intromodedemploi">Select countries and indicator:
        </div>
        <div id="selCountry">
            <select id="country_dropdown" data-maximum-selection-length="2" 2 multiple="multiple">

            </select>
        </div>
        <div id="selIndicator">
            <select id="indicator_dropdown">
            </select>
        </div>
    </div>
<div id="chartSlider" class="img-comp-container">
    <div id="chartSlider1" class="img-comp-img">
        <div id="scenario1" alt=""></div>
    </div>
    <div id="chartSlider2" class="img-comp-img img-comp-overlay">
        <div id="scenario2" alt=""></div>
    </div>
</div>

    <script  type="text/javascript">
                    
        var startChart = "2018-Q1";
        var startForecast = "2020-Q1";

        var allScenario1, allScenario2, allCou;
        var popupWidth;


        var color = ["#E73741", "#0F8FD9", "#993484", "#DF521E", "#719E24"];

        var margin = { top: 10, right: 50, bottom: 30, left: 80 };

        var mapRatio = 9 / 20;

    var width = document.getElementById("chartSlider").offsetWidth - margin.left - margin.right;
    
        var height;
        if (width > 650)
            height = width * mapRatio;
        else
            height = width;


        $(document).ready(function () {
            $('#country_dropdown').select2({ width: '180px' });               
        });

        if (width > 650)
            $(document).ready(function () {
                $('#indicator_dropdown').select2({ width: '415px' });
            });
        else
            $(document).ready(function () {
                $('#indicator_dropdown').select2({ width: '180px' });
            });
        

        var urls = {
            scenario1: "data/EO107_INTERNET_1.tsv",
            scenario2: "data/EO107_INTERNET_2.tsv",
            country: "data/coord_country.tsv",
        };

        d3.queue()
            .defer(d3.tsv, urls.scenario1)
            .defer(d3.tsv, urls.scenario2)
            .defer(d3.tsv, urls.country)
            .await(render);




        var scenario1SVG = d3.select("#scenario1").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        var scenario2SVG = d3.select("#scenario2").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

        // Add X axis --> it is a date format
        var x = d3.scaleLinear()
                    .range([0, width]);

        function dateParser(d){
            var splitted = d.split('-');
            var quarterEndMonth = splitted[1].charAt(1) * 3;
            var quarterStartMonth = quarterEndMonth - 3;
            
            return d3.timeParse('%m-%Y')(quarterStartMonth + '-' + splitted[0]);
        }

        //Add Y axis
        var y = d3.scaleLinear() //or scaleLog
            .range([height, 0]);

        function set_Cou_Dropdown(data) {

            //  document.getElementById("country_dropdown").innerHTML = "<option value=\"-\" selected=\"selected\"> - </option>";
            var count = 0;
            data.forEach(function (d) {
                var x = document.getElementById("country_dropdown");
                var option = document.createElement("option");
                option.value = d.values[0].LOCATION;
                option.innerHTML = d.key;
                x.appendChild(option);
                count++;
                if (count == data.length-1){
                    //  $('#country_dropdown').select2().select2('val', 'OTO');
                    $('#country_dropdown').select2().val('OTO');
                }
                    
            })
        }


        function set_Ind_Dropdown(data) {

            // document.getElementById("indicator_dropdown").innerHTML = "<option value=\"-\" selected=\"selected\"> - </option>";
            var count=0;
            data.forEach(function (d) {
                var x = document.getElementById("indicator_dropdown");
                var option = document.createElement("option");
                option.value = d.values[0].VARIABLE;
                option.innerHTML = d.key;
                x.appendChild(option);
                count++;
                if(count==data.length-1){
                    
                    //$('#indicator_dropdown').select2().select2('val', 'GDPVD_CAP');
                    $('#country_dropdown').select2().val('GDPVD_CAP');
                }

            })

        }

        function render(err,scenario1Data,scenario2Data,country) {
            allScenario1=scenario1Data;
            allScenario2=scenario2Data;
            allCou=country;

            var countryList = d3.nest()
                .key(function (d) { return d.Country; }).sortKeys(d3.ascending)
                .entries(scenario1Data);
            
            var indicatorList = d3.nest()
                .key(function (d) { return d.Variable; }).sortKeys(d3.ascending)
                .entries(scenario1Data);

                set_Cou_Dropdown(countryList);
                set_Ind_Dropdown(indicatorList);

            
        }
        function countryName(ISOcode){
            var name;
            allCou.forEach(function (d) {
                if(d.ISO3== ISOcode){
                    name= d.Country;
                }
                
            })
            return name;
        }

        function updateChart(){


            scenario1SVG.selectAll("*").remove()

            scenario2SVG.selectAll("*").remove()


            selCountries=$('#country_dropdown').select2("val");
            selindic = $('#indicator_dropdown').select2("val");

            
            var data1= allScenario1.filter(function(d){ return (d.LOCATION== selCountries[0] && d.VARIABLE== selindic && dateParser(d.TIME) >= dateParser(startChart)) || (d.LOCATION == selCountries[1] && d.VARIABLE == selindic && dateParser(d.TIME) >= dateParser(startChart));})
            var data2 = allScenario2.filter(function (d) { return (d.LOCATION == selCountries[0] && d.VARIABLE == selindic && dateParser(d.TIME) >= dateParser(startChart)) || (d.LOCATION == selCountries[1] && d.VARIABLE == selindic && dateParser(d.TIME) >= dateParser(startChart)); })
            var data=[];
            data1.forEach(function(d){
                 data2.forEach(function (k) {
                     if(k.TIME==d.TIME && k.LOCATION==d.LOCATION){
                        d.Scenario1Val=d.Value;
                        d.Scenario2Val = k.Value;
                     }
                     

                    })
             })

           data2.forEach(function (d) {

                data.push({ "TIME": d.TIME, "Unit": d.Unit, "Value": d.Value, "Variable": d.Variable, "Scenario": "Scenario2" })
            })
            
            if(data1.length >0){

                x.domain(d3.extent(data1, function (d) { return dateParser(d.TIME); }))

                y.domain([d3.min(data1, function (d) { return d3.min([parseFloat(d.Scenario1Val), parseFloat(d.Scenario2Val)]); }), d3.max(data1, function (d) { return d3.max([parseFloat(d.Scenario1Val), parseFloat(d.Scenario2Val)]); })])

                var scenarioChart=[scenario1SVG, scenario2SVG]

                for(k=0;k<=1;k++){
                    //var formatQuarter = d3.timeFormat("%q-%Y");
                    scenarioChart[k]
                        .append("g")
                        .attr("class", "axisContext")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x).ticks(8)
                            .tickFormat(function (x) {
                                // get the milliseconds since Epoch for the date
                                var milli = (x + 7884000000);

                                // calculate new date 10 seconds earlier. Could be one second, 
                                // but I like a little buffer for my neuroses
                                var vanilli = new Date(milli);

                                // calculate the month (0-11) based on the new date
                                var mon = vanilli.getMonth();
                                var yr = vanilli.getFullYear();

                                // return appropriate quarter for that month
                                if (mon <= 2) {
                                    return "Q1 -" + yr;
                                } else if (mon <= 5) {
                                    return "Q2 - " + yr;
                                } else if (mon <= 8) {
                                    return "Q3 - " + yr;
                                } else {
                                    return "Q4 - " + yr;
                                }
                            }));


                    scenarioChart[k].append("g")
                        .attr("class", "axisContext")
                        .call(d3.axisLeft(y).tickFormat(function (d) {
                            return y.tickFormat(10, d3.format(".2f"))(d)
                        }).tickSize(-(width)));


                    for (i = 0; i < selCountries.length; i++) {
                        // Draw the line
                        scenarioChart[k]
                            .append("path")

                            .attr("fill", "none"/*"#8DCD79"*/)
                            .attr("stroke", function (d) { return color[i] })
                            .attr("stroke-width", function () { if (k == 0) return 6; else return 1;})
                            .attr("class", "lineContext")
                            .attr("id", function (d) { return "singleHit" + i; })
                            //  .attr("id", function (d) { return identifier.split(' ').join('').replace("*", "").replace("\''", "").replace("-", "").replace("(", "").replace(")", "") + "area"; })
                            .attr("d", function (d) {
                                return d3.line()//area
                                    .x(function (d) { return x(dateParser(d.TIME)); })
                                    // .y0(y(0))
                                    .y(function (d) { return y(parseFloat(d.Scenario1Val)); })
                                    (data1.filter(function (d) { return d.LOCATION == selCountries[i]; }))
                            })

                        // Draw the line
                        scenarioChart[k]
                            .append("path")
                            .attr("fill", "none"/*"#8DCD79"*/)
                            .attr("stroke", function (d) { return color[i] })
                            .attr("stroke-width", function () { if (k == 0) return 1; else return 6;})
                            .attr("opacity", function(){if(k==0)return 0.2; else return 1;})
                            .attr("class", "lineContext")
                            .attr("id", function (d) { return "doubleHit" + i; })
                            .attr("d", function (d) {

                                return d3.line()//area
                                    .x(function (d) { return x(dateParser(d.TIME)); })
                                    // .y0(y(0))
                                    .y(function (d) { return y(parseFloat(d.Scenario2Val)); })
                                    (data1.filter(function (d) { return d.LOCATION == selCountries[i]; }))
                            })

                        // Draw dashedline
                        scenarioChart[k]
                            .append("path")
                            //.datum(data)
                            .attr("fill", "none"/*"#8DCD79"*/)
                            .attr("stroke", function (d) { return "#DDE9EF" })
                            .style("stroke-dasharray", ("10, 10"))
                            .attr("stroke-width",  function () { if (k == 0) return 6; else return 1; })
                            .attr("class", "lineContext")
                            //  .attr("id", function (d) { return identifier.split(' ').join('').replace("*", "").replace("\''", "").replace("-", "").replace("(", "").replace(")", "") + "area"; })
                            .attr("d", function (d) {
                                return d3.line()//area
                                    .x(function (d) { return x(dateParser(d.TIME)); })
                                    // .y0(y(0))
                                    .y(function (d) { return y(parseFloat(d.Scenario1Val)); })
                                    (data1.filter(function (d) { return (d.LOCATION == selCountries[i] && dateParser(d.TIME) >= dateParser(startForecast)); }))
                            })

                        // Draw dashedline
                        scenarioChart[k]
                            .append("path")
                            .attr("fill", "none"/*"#8DCD79"*/)
                            .attr("stroke", function (d) { return "#DDE9EF" })
                            .style("stroke-dasharray", ("10, 10"))
                            .attr("stroke-width",  function () { if (k == 0) return 1; else return 6; })
                            .attr("class", "lineContext")
                            .attr("d", function (d) {

                                return d3.line()//area
                                    .x(function (d) { return x(dateParser(d.TIME)); })
                                    // .y0(y(0))
                                    .y(function (d) { return y(parseFloat(d.Scenario2Val)); })
                                    (data1.filter(function (d) { return (d.LOCATION == selCountries[i] && dateParser(d.TIME) >= dateParser(startForecast)); }))
                            })

                        // Draw the area
                        scenarioChart[k]
                            .append("path")
                            //.datum(data)
                            .attr("fill", function (d) { return color[i] })
                            .attr("stroke", "none")
                            .attr("opacity", 0.05)
                            //.attr("class", "lineContext")
                            //  .attr("id", function (d) { return identifier.split(' ').join('').replace("*", "").replace("\''", "").replace("-", "").replace("(", "").replace(")", "") + "area"; })
                            .attr("d", function (d) {

                                return d3.area()
                                    .x(function (d) { return x(dateParser(d.TIME)); })
                                    .y0(function (d) { return y(parseFloat(d.Scenario1Val)); })
                                    .y1(function (d) { return y(parseFloat(d.Scenario2Val)); })
                                    (data1.filter(function (d) { return d.LOCATION == selCountries[i]; }))
                            })
                        scenarioChart[k].append("text")
                            .append("textPath") //append a textPath to the text element
                            .attr("xlink:href", function (d) { return "#singleHit" + i; }) //place the ID of the path here
                            .style("text-anchor", "middle") //place the text halfway on the arc
                            .attr("startOffset", "85%")
                            .attr("opacity", function () { if (k == 0) return 1; else return 0.15; })
                            .text(function (d) { return countryName(selCountries[i]) + ": Singlele-hit scenario"; });

                        scenarioChart[k].append("text")
                            .append("textPath") //append a textPath to the text element
                            .attr("xlink:href", function (d) { return "#doubleHit" + i; })  //place the ID of the path here
                            .style("text-anchor", "middle") //place the text halfway on the arc
                            .attr("startOffset", "85%")
                            .attr("opacity", function () { if (k == 0) return 0.15; else return 1; })
                            .text(function (d) { return countryName(selCountries[i]) + ": Double-hit scenario"; });

                    }
                }
               

            }
        }
    d3.xml("https://stats.oecd.org/restsdmx/sdmx.ashx/GetData/EO107_INTERNET_1/AUS+AUT+BEL+CAN+CHL+COL+CZE+DNK+EST+FIN+FRA+DEU+GRC+HUN+ISL+IRL+ISR+ITA+JPN+KOR+LVA+LTU+LUX+MEX+NLD+NZL+NOR+POL+PRT+SVK+SVN+ESP+SWE+CHE+TUR+GBR+USA+EA17+OTO+WLD+ARG+BRA+BGR+CHN+CRI+IND+IDN+ROU+RUS+ZAF.CBGDPR+GFAR+GGFLQ+NLGQ+NLGXQ+GGFLMQ+CQ_ISKV+XGSV+CGV+ITISKV+GDP+GDPV+ITV+MGSV+CQ_FBGSV+CPV+GDP_ANNPCT+YDH_G+CPI+CPIH+PCORE+PCOREH+PXGS+PGDP+PMGS+ET+UNR.Q/all?startTime=2007-Q1&endTime=2021-Q4", function (data) {
console.log(data)
    })


    ////////////////////
    //Comparison Charts
    ////////////////////


    function initComparisons() {
        var x, i;
        /* Find all elements with an "overlay" class: */
        x = document.getElementsByClassName("img-comp-overlay");
        for (i = 0; i < x.length; i++) {
            /* Once for each "overlay" element:
            pass the "overlay" element as a parameter when executing the compareImages function: */
            compareImages(x[i]);
        }
        function compareImages(img) {
            var slider, img, clicked = 0, w, h;
            /* Get the width and height of the img element */
            w = img.offsetWidth;
            h = img.offsetHeight;
            /* Set the width of the img element to 50%: */
            img.style.width = (3*w / 4) + "px";
            /* Create slider: */
            slider1 = document.createElement("DIV");
            slider1.setAttribute("class", "img-comp-slider");
            slider1.innerHTML="<img class=\"slider-pic\" src='img/nav.png' />";
            slider= document.createElement("DIV");
            slider.setAttribute("class", "img-comp-slider-line");
            slider.style.height = height+margin.top+margin.bottom;
            slider1.style.transform = "translate(-20px,"+(height )/2+"px)";
            slider.appendChild(slider1);
            /* Insert slider */
            img.parentElement.insertBefore(slider, img);
            /* Position the slider in the middle: */
            slider.style.top = 0 + "px";/*(h / 2) - (slider.offsetHeight / 2) + "px";*/
            slider.style.left = (3*w / 4) - (slider.offsetWidth / 2) + "px";
            /* Execute a function when the mouse button is pressed: */
            slider.addEventListener("mousedown", slideReady);
            /* And another function when the mouse button is released: */
            window.addEventListener("mouseup", slideFinish);
            /* Or touched (for touch screens: */
            slider.addEventListener("touchstart", slideReady);
            /* And released (for touch screens: */
            window.addEventListener("touchstop", slideFinish);
            function slideReady(e) {
                /* Prevent any other actions that may occur when moving over the image: */
                e.preventDefault();
                /* The slider is now clicked and ready to move: */
                clicked = 1;
                /* Execute a function when the slider is moved: */
                window.addEventListener("mousemove", slideMove);
                window.addEventListener("touchmove", slideMove);
            }
            function slideFinish() {
                /* The slider is no longer clicked: */
                clicked = 0;
            }
            function slideMove(e) {
                var pos;
                /* If the slider is no longer clicked, exit this function: */
                if (clicked == 0) return false;
                /* Get the cursor's x position: */
                pos = getCursorPos(e)
                /* Prevent the slider from being positioned outside the image: */
                if (pos < 0) pos = 0;
                if (pos > w) pos = w;
                /* Execute a function that will resize the overlay image according to the cursor: */
                slide(pos);
            }
            function getCursorPos(e) {
                var a, x = 0;
                e = e || window.event;
                /* Get the x positions of the image: */
                a = img.getBoundingClientRect();
                /* Calculate the cursor's x coordinate, relative to the image: */
                x = e.pageX - a.left;
                /* Consider any page scrolling: */
                x = x - window.pageXOffset;
                return x;
            }
            function slide(x) {
                /* Resize the image: */
                img.style.width = x + "px";
                /* Position the slider: */
                slider.style.left = img.offsetWidth - (slider.offsetWidth / 2) + "px";
            }
        }
    }
    initComparisons();
        $("#country_dropdown").change(function () {
            updateChart()
        });

        $("#indicator_dropdown").change(function () {
            updateChart()
        });

    </script>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P5JSM4P" height="0" width="0"
        style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!--End Google Tag Manager (noscript) -->
</body>